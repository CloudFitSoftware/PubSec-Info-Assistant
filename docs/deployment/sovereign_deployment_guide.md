## Table of Contents <!-- omit in toc -->

- [Sovereign Cloud Deployment Guide](#sovereign-cloud-deployment-guide)
  - [Create required Azure Subscriptions](#create-required-azure-subscriptions)
  - [Creating the instance of Azure OpenAI API](#creating-the-instance-of-azure-openai-api)
    - [Request and Opt-Out Steps](#request-and-opt-out-steps)
    - [OpenAI Configuration Steps](#openai-configuration-steps)
  - [Accept the terms of the "Responsible AI Notice"](#accept-the-terms-of-the-responsible-ai-notice)
  - [Configure your local environment](#configure-your-local-environment)
    - [Install](#install)
      - [Build requirements](#build-requirements)
      - [Node/NPM](#nodenpm)
      - [Build Dependencies](#build-dependencies)
      - [az-cli](#az-cli)
  - [Configure the deployment](#configure-the-deployment)
  - [Execute the deployment](#execute-the-deployment)
  - [Upload files for indexing](#upload-files-for-indexing)
  - [Manually initiating the indexing process](#manually-initiating-the-indexing-process)
  - [Demo of chat/search](#demo-of-chatsearch)
  - [Copying databases and documents between environments](#copying-databases-and-documents-between-environments)

# Sovereign Cloud Deployment Guide

**NOTE**: This deployment guide only works for **US Gov** tenants

## Create required Azure Subscriptions

1. Create subscription Azure
    -  Microsoft Azure Government subscription

## Creating the instance of Azure OpenAI API

### Request and Opt-Out Steps

1. Request access to Azure OpenAI API:

   - <https://aka.ms/oaiapply>
   - NOTE: Azure OpenAI is only available in Microsoft Azure Commercial subscription. Be sure to use that subscription ID in that form.

1. After Azure OpenAI request access is approved, opt out of content filtering and abuse monitoring:

   - [Opt-Out Request](https://customervoice.microsoft.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR7en2Ais5pxKtso_Pz4b1_xURE01NDY1OUhBRzQ3MkQxMUhZSE1ZUlJKTiQlQCN0PWcu)
   - The form expects the Application ID from the approval email from Cognitive Services Gating Support (<csgate@microsoft.com>) with subject "Welcome to the Azure OpenAI Service, YourFirstName! [ApplicationID ZZZZZZXX]" where YourFirstName is your name and ZZZZZZXX is the Application ID you need to enter into this form.

1. Create an instance of [Azure OpenAI](https://portal.azure.us/#create/Microsoft.CognitiveServicesOpenAI). Ideally, the name should start with infoasst-aoai- to match the names of resources generated by this project's scripts. Make a note of the name for use in the deployment scripts.

### OpenAI Configuration Steps

1. Open the instance of Azure OpenAI and click Model deployments on the left menu.

1. Click the Manage Deployments button. The browser will navigate to Azure AI Studio.

1. In Azure AI Studio, click Deployments on the left.

1. In the Deployments screen, click Create new deployment.

1. In the Deploy model dialog, enter the following values:

   - Select a model: gpt-35-turbo
   - Deployment name: gpt-35-turbo
   - Accept the defaults for the other settings.

1. In the Deploy model dialog, click the Create button

1. Repeat the above steps with the following values:

   - Select a model: text-embedding-ada-002
   - Deployment name: text-embedding-ada-002
   - Accept the defaults for the other settings.

1. Open the instance of Azure OpenAI and click Keys and Endpoints on the left menu.

1. Make a note of the value of key 1. This is a secret, so keep it safe.

## Accept the terms of the "Responsible AI Notice"

If you have never accepted the terms of the "Responsible AI Notice", follow these steps.

1. In the Microsoft Azure Government subscription, create an instance of [Azure Cognitive Services](https://portal.azure.us/#create%252FMicrosoft.CognitiveServicesAllInOne).

1. On the Basics tab, select the Microsoft Azure Government subscription and enter anything else for the other values.

1. Review the "Responsible AI Notice" and check the box to acknowledge that you have read and understood the terms of the "Responsible AI Notice".

1. Click the Review + Create button.

1. After the resource has been created, you can delete it.

## Configure your local environment

**Note**: This deployment method only works on Linux (native or WSL)

### Install 
Run the following commands.  These assume Ubuntu, but use the appropriate package manager for your Linux distribution

#### Build requirements
#### Node/NPM
```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

nvm install node
```

#### Build Dependencies
```bash
sudo apt-get install figlet zip jq
```

#### az-cli
[Microsoft Documentation](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli-linux?pivots=apt#option-1-install-with-one-command)

Quick Step
```bash
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```

## Configure the deployment

1. In the scripts/environments folder, copy local.env.example to local.env.

1. Note that local.env will be ignored by git. Since it will contain secrets, do not force git to commit the file.

1. In the local.env file, enter the following values:

   - LOCATION: usgovvirginia
   - WORKSPACE: used to create the resource group containing the deployment. resource group will be in the format `infoasst-ZZZZZZ` where `ZZZZZZ` is the name you specify for the workspace
   - SUBSCRIPTION_ID: the ID of the Microsoft Azure Government subscription
   - TENANT_ID: the ID of the Microsoft Azure Government Tenant
   - IS_USGOV_DEPLOYMENT: true
   - USE_EXISTING_AOAI: true
   - AZURE_OPENAI_SERVICE_NAME: the name of the Azure Open AI instance you created
   - AZURE_OPENAI_SERVICE_KEY: the value of Key 1 of the Azure Open AI instance you created
   - AZURE_OPENAI_CHATGPT_DEPLOYMENT: gpt-35-turbo
   - USE_AZURE_OPENAI_EMBEDDINGS: true
   - AZURE_OPENAI_EMBEDDING_DEPLOYMENT_NAME: text-embedding-ada-002
   - CHAT_WARNING_BANNER_TEXT: We suggest something like "DEV / UNCLASSIFIED / NO CUI"

   The following values can be found via the `Deployments` section at the [OpenAI Portal](https://oai.azure.com)

   - AZURE_OPENAI_CHATGPT_MODEL_NAME:
   - AZURE_OPENAI_CHATGPT_MODEL_VERSION:
   - AZURE_OPENAI_EMBEDDINGS_MODEL_NAME:
   - AZURE_OPENAI_EMBEDDINGS_MODEL_VERSION:

## Execute the deployment

1. In the root of the project, run the following az commands:

   - `az cloud set --name AzureUSGovernment`
   - `az login --use-device-code`
     - The console will display a special url <https://microsoft.com/deviceloginus> for AzureUSGovernment and a code. Use them to log into your Microsoft Azure Government subscription.
   - `az account set --subscription <ID of your Microsoft Azure Government subscription>`

1. In the root of the project, run `make deploy`.

1. Review the console for the changes the bicep files will deploy. Press `y` to apply or `n` to cancel.

## Upload files for indexing

1. Open your browser and navigate to the url of the web app which is <https://infoasst-web-ZZZZZZ.azurewebsites.us> where ZZZZZZ is the value in the file infra/.state/\<workspacename\>/random.txt. This file won't exist until `make deploy` is run.

1. When the site loads, click Manage Content in the upper right-hand corner of the screen.

1. Either click to add files or drop and drop them into the rectangle. Click the Upload button to upload the files. You may need to scroll down to see it. Unfortunately, the screen will not display the upload status of the files.

1. After the files are uploaded, you can check the status of the file processing on the Upload Status tab. You may need to click the Refresh button to see updates.

1. Wait until all files uploaded have a status of Completed, Error, or Skipped.

## Manually initiating the indexing process

The search indexer runs every 60 minutes, but you can initiate it now by following these steps.

1. In the Microsoft Azure Government subscription, click All Resources and select the resource named infoasst-search-ZZZZZZ where ZZZZZZ is the value in the file infra/.state/\<workspacename\>/random.txt.

1. Click Indexers on the left menu under Search management.

1. Click all-files-indexer.

1. Click Run and wait for indexing to complete. You can monitor the indexing process from this screen. If you uploaded a lot of files, it may take multiple runs to completely index all files. Keep running the indexer until Status is Success and Docs succeeded is 0/0.

## Demo of chat/search

1. Open your browser and navigate to the url of the web app which is <https://infoasst-web-ZZZZZZ.azurewebsites.us> where ZZZZZZ is the value in the file infra/.state/\<workspacename\>/random.txt. This file won't exist until "make deploy" is run.

1. Click Help in the upper right-hand side of the page to view general information about the demo.

1. Click Chat in the upper right-hand side of the page to return to the chat page.

1. At any time, you can click Adjust in the upper right-hand side of the page to change how the AI responds to your messages.

1. Do NOT select the checkbox for "Use semantic ranker for retrieval". Semantic search is not yet available in Azure Government subscriptions.

1. Use the textbox at the bottom of the page to chat with the AI.

1. When the AI responds, you can click the icons in the upper right of the response to inspect the details that went into creating the response.

1. Click Clear chat in the upper right-hand side of the page to start a new chat.

## Copying databases and documents between environments

1. To prevent reprocessing documents uploaded during these steps, you must stop the destination Azure Function application and destination Azure Cognitive Search service.

    1. Stop the destination Azure Function application before continuing.  The name of the Azure Function application is infoasst-func-ZZZZZZ where ZZZZZZ is the value in the file infra/.state/\<workspacename\>/random.txt. This file won't exist until "make deploy" is run.

        1. Open your browser and navigate to the destination Azure Function application.

        1. On the Overview tab, click Stop.

        1. Click Yes to confirm stopping the Azure Function.

    1. Stop the all-files-indexer indexer in the destination Azure Cognitive Search service before continuing. The name of the Azure Cognitive Search service is infoasst-search-ZZZZZZ where ZZZZZZ is the value in the file infra/.state/\<workspacename\>/random.txt. This file won't exist until "make deploy" is run.

        1. Open your browser and navigate to the destination Azure Cognitive Search service.

        1. Click Indexers on the left menu under Search management.

        1. Click all-files-indexer.

        1. Click the Indexer Definition (JSON) tab.

        1. In the JSON file, locate the disabled property. By default the disabled property is set to null.

        1. Change the value of the disabled property to true.

        1. Click Save to save your changes.

1. Configure the PowerShell script to export data and documents from the source environment.

    1. Open the file named ExportDatabases.ps1 located under `./scripts/` at the root of the project.

    1. Update these variables at the top of the file with the appropriate values.

        - $SourceCosmosDBConnectionString
        - $SourceCognitiveSearchName
        - $SourceAdminKey
        - $SourceStorageAccountName
        - $SourceStorageAccountKey
        - $SourceFunctionAppName

    1. Save your changes to ExportDatabases.ps1 by selecting File > Save from the menu bar.

1. Configure the PowerShell script to import data and documents into the destination environment.

    1. Open the file named ImportDatabases.ps1 located under `./scripts/` at the root of the project.

    1. Update these variables at the top of the file with the appropriate values.

        - $SourceStorageAccountName
        - $SourceFunctionAppName

    1. Configure the destination Cosmos DB connection string. The name of the Azure Cosmos DB account is infoasst-cosmos-ZZZZZZ where ZZZZZZ is the value in the file infra/.state/\<workspacename\>/random.txt. This file won't exist until "make deploy" is run.

        1. Open your browser and navigate to the destination Azure Cosmos DB account.

        1. Click Keys on the left menu under Settings.

        1. Click the blue eye icon to the right of the PRIMARY CONNECTION STRING textbox.

        1. After the PRIMARY CONNECTION STRING is displayed, click the copy icon on the right side of the textbox.

        1. In ImportDatabases.ps1, update $DestinationCosmosDBConnectionString with the value of the PRIMARY CONNECTION STRING.

    1. Configure the destination Cognitive Search settings. The name of the Azure Cognitive Search account is infoasst-search-ZZZZZZ where ZZZZZZ is the value in the file infra/.state/\<workspacename\>/random.txt. This file won't exist until "make deploy" is run.

        1. Open your browser and navigate to the destination Azure Cognitive Search service.

        1. In ImportDatabases.ps1, update $DestinationCognitiveSearchName with the name of the destination Azure Cognitive Search service.

        1. Click Keys on the left menu under Settings.

        1. Click the copy icon on the right side of the Primary admin key textbox.

        1. In ImportDatabases.ps1, update $DestinationAdminKey with the value of the Primary admin key.

    1. Configure the destination Storage account settings. The name of the Azure Storage account is infoasststoreZZZZZZ where ZZZZZZ is the value in the file infra/.state/\<workspacename\>/random.txt. This file won't exist until "make deploy" is run.

        1. Open your browser and navigate to the destination Azure Storage account.

        1. In ImportDatabases.ps1, update $DestinationStorageAccountName with the name of the destination Azure Storage account.

        1. Click Access keys on the left menu under Security + networking.

        1. In the key1 section, click the Show button to the right of the Key textbox.

        1. After the Key is displayed, click the copy icon on the right side of the textbox.

        1. In ImportDatabases.ps1, update $DestinationStorageAccountKey with the value of the Key.

    1. Configure the destination Azure Function account settings. The name of the Azure Function account is infoasst-func-ZZZZZZ where ZZZZZZ is the value in the file infra/.state/\<workspacename\>/random.txt. This file won't exist until "make deploy" is run.

        1. Open your browser and navigate to the destination Azure Function account.

        1. In ImportDatabases.ps1, update $DestinationFunctionAppName with the name of the destination Azure Function account.

    1. Save your changes to ImportDatabases.ps1 by selecting File > Save from the menu bar.

1. Perform the export process.

    1. Open a new terminal window by selecting Terminal > New Terminal from the menu bar.

    1. In the terminal, type pwsh and press enter to start PowerShell core.

    1. In the terminal, type .\ExportDatabases.ps1 and press enter to start the export process.

    1. Monitor the output in the terminal for any errors. Note: Due to data egress limits in Azure, this process will take several hours to complete.

1. Perform the import process.

    1. Open a new terminal window by selecting Terminal > New Terminal from the menu bar.

    1. In the terminal, type pwsh and press enter to start PowerShell core.

    1. In the terminal, type .\ImportDatabases.ps1 and press enter to start the import process.

    1. Monitor the output in the terminal for any errors. Note: This process will take a fraction of the time that the export process did.

1. Start the destination Azure Function application and destination Azure Cognitive Search service that you stopped in the previous steps.

    1. Start the destination Azure Function application.  The name of the Azure Function application is infoasst-func-ZZZZZZ where ZZZZZZ is the value in the file infra/.state/\<workspacename\>/random.txt. This file won't exist until "make deploy" is run.

        1. Open your browser and navigate to the destination Azure Function application.

        1. On the Overview tab, click Start.

    1. Start the all-files-indexer indexer in the destination Azure Cognitive Search service before continuing. The name of the Azure Cognitive Search service is infoasst-search-ZZZZZZ where ZZZZZZ is the value in the file infra/.state/\<workspacename\>/random.txt. This file won't exist until "make deploy" is run.

        1. Open your browser and navigate to the destination Azure Cognitive Search service.

        1. Click Indexers on the left menu under Search management.

        1. Click all-files-indexer.

        1. Click the Indexer Definition (JSON) tab.

        1. In the JSON file, locate the disabled property.

        1. Change the value of the disabled property to null.

        1. Click Save to save your changes.
